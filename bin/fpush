#!/usr/bin/env perl
use FindBin;
use IPC::Run run;

# this is a pretty sloppy script but it keeps several flinkt dev instances in sync with the appropriate "couchapp push"

my $couchapp = `which couchapp`;
chomp $couchapp;

my $selector = $FindBin::Bin . "/../webclient/_attachments/js/selector-dev.js";
unless (-e $selector) {
    die "no file at $selector";
}

my $url = `grep 'var site = ' '$selector'`;
chomp $url;
unless ($url) {
    die "failed to find site variable declaration in $selector"
}

$url =~ s/^.*var site = //;
$url =~ s/^['"](.*)['"];\s*$/$1/;

print STDERR "pushing to $url with $couchapp\n";

my $child_pid;

if ($url eq 'http://www.flinkt.org' and not `hostname` =~ /sakohtland/) {
    $url = 'http://localhost:5982';
    print STDERR "Rewriting site as $url\n";
}
else {
    my $cmd = 'ps ax | grep couchdb | grep -v grep';
    if ($url =~ /localhost/) {
        my @out = `$cmd`;
        if (@out == 0) {
            print STDERR "couchdb not running: starting couchdb server to take updates...\n";
            $child_pid = fork();
            if (not $child_pid) {
                my $cmd = 'couchdb -a "' . $FindBin::Bin . '/../etc-couchdb/local.ini"';
                # child
                exec $cmd;
            }
        }
    }
    else {
        my $host = $url;
        $host =~ s|^http.*://||;
        
        if ($host =~ /^(.*?)\:(.*?)$/) {
            $host = $1;
        }
        
        $cmd = "ssh $host '$cmd' 2>&1";
        print "RUN $cmd\n";
        my @out = `$cmd`;
        print "DONE\n";
        if (@out == 0) {
            die "couchdb not running on $host?";
        }
        elsif (@out > 0 and grep { $_ !~ /couchdb/ } @out) {
            die "ERROR CONNECTING TO $host:\n@out\n";
        }
    }
}

if ($ENV{FLINKTP} and $ENV{FLINKTU}) {
    print STDERR "setting user and password\n";
    my $up = "$ENV{FLINKTU}:$ENV{FLINKTP}";
    $url =~ s|//|//$up\@|;
}

my $cmd = "$couchapp push $url/flinktdb";
print "RUN: $cmd\n";
my $rv = system $cmd;
$rv /= 256;
if ($rv) {
    die "ERROR: $!\n";
}
if ($child_pid) {
    print STDER "killing temporary couchdb server\n";
    system "kill $child_pid";
}

